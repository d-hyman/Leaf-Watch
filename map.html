<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NASA GIBS Historical Map Viewer</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif;overflow:hidden}
    #map{width:100vw;height:100vh}
    .controls{position:absolute;top:20px;right:20px;background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.15);z-index:1000;max-width:320px}
    .controls h3{margin-bottom:15px;font-size:16px;color:#333}
    .date-display{font-size:24px;font-weight:700;color:#06c;margin-bottom:15px;text-align:center}
    .layer-select{margin-bottom:15px}
    .layer-select label{display:block;margin-bottom:5px;font-size:14px;color:#555}
    .layer-select select{width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;font-size:14px}
    .timeline-slider{width:100%;margin:15px 0}
    input[type="range"]{width:100%;height:6px;border-radius:3px;background:#e0e0e0;outline:none}
    input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:18px;height:18px;border-radius:50%;background:#06c;cursor:pointer;box-shadow:0 2px 4px rgba(0,0,0,.2)}
    input[type="range"]::-moz-range-thumb{width:18px;height:18px;border-radius:50%;background:#06c;cursor:pointer;border:none;box-shadow:0 2px 4px rgba(0,0,0,.2)}
    .year-labels{display:flex;justify-content:space-between;font-size:12px;color:#666;margin-top:5px}
    .play-controls{display:flex;gap:10px;margin-top:15px}
    button{flex:1;padding:10px;background:#06c;color:#fff;border:none;border-radius:6px;font-size:14px;cursor:pointer;transition:background .2s}
    button:hover{background:#0052a3}
    button:disabled{background:#ccc;cursor:not-allowed}
    
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="controls">
    <h3>NASA Earth Observation</h3>
    <div class="date-display" id="dateDisplay">—</div>

    <div class="layer-select">
      <label>Layer Type:</label>
      <select id="layerSelect">
        <option value="MODIS_Terra_CorrectedReflectance_TrueColor">True Color (Terra/MODIS)</option>
        <option value="MODIS_Aqua_CorrectedReflectance_TrueColor">True Color (Aqua/MODIS)</option>
        <option value="VIIRS_SNPP_CorrectedReflectance_TrueColor">True Color (VIIRS/SNPP)</option>
        <option value="MODIS_Terra_NDVI_8Day">NDVI (MODIS Terra, 8-Day)</option>
      </select>
    </div>

    <div class="timeline-slider">
      <input type="range" id="timeSlider" min="0" max="1" value="0" step="1">
      <div class="year-labels">
        <span id="labelStart">Start</span>
        <span id="labelMid">Mid</span>
        <span id="labelEnd">End</span>
      </div>
    </div>

    <div class="play-controls">
      <button id="playBtn">▶ Play</button>
      <button id="todayBtn">Today</button>
    </div>
  </div>

  <script>
    // -------- Per-layer metadata --------
    // NDVI is 8-day PNG; daily products are JPG.
    // 'phase' anchors NDVI to 2025-11-05 so the grid is {..., 2025-10-28, 2025-11-05, 2025-11-13, ...}
    const LAYER_META = {
      MODIS_Terra_CorrectedReflectance_TrueColor: { ext: "jpg", stepDays: 1, start: "2000-02-24" },
      MODIS_Aqua_CorrectedReflectance_TrueColor:  { ext: "jpg", stepDays: 1, start: "2002-07-04" },
      VIIRS_SNPP_CorrectedReflectance_TrueColor:  { ext: "jpg", stepDays: 1, start: "2012-01-20" },
      MODIS_Terra_NDVI_8Day:                      { ext: "png", stepDays: 8, start: "2000-02-18", phase: "2025-11-05" }
    };

    // ---------- Map / UI refs ----------
    const map = L.map('map', { center: [20,0], zoom: 3, minZoom: 2, maxZoom: 9 });
    let currentLayer = null;
    let playing = false;

    const timeSlider  = document.getElementById('timeSlider');
    const dateDisplay = document.getElementById('dateDisplay');
    const layerSelect = document.getElementById('layerSelect');
    const playBtn     = document.getElementById('playBtn');
    const todayBtn    = document.getElementById('todayBtn');
    //const loading     = document.getElementById('loading');
    const labelStart  = document.getElementById('labelStart');
    const labelMid    = document.getElementById('labelMid');
    const labelEnd    = document.getElementById('labelEnd');

    // ---------- Date helpers ----------
    const DAY = 86400000;
    function toISODate(d){ return new Date(d).toISOString().slice(0,10); }
    function addDays(d,n){ const x = new Date(d); x.setDate(x.getDate()+n); return x; }
    function daysBetween(a,b){ return Math.floor((b-a)/DAY); }
    function getMeta(id){ return LAYER_META[id] || { ext:"jpg", stepDays:1, start:"2000-01-01" }; }
    function getProductStart(id){ return new Date(getMeta(id).start); }
    function today(){ return new Date(); }

    // Use a global base so one slider works for all layers.
    const GLOBAL_BASE_START = new Date("2000-02-18"); // earliest product start among our layers
    function dateFromSlider(idx){ const d = new Date(GLOBAL_BASE_START); d.setDate(d.getDate()+parseInt(idx,10)); return d; }

    // First phase-aligned date ON/AFTER product start (with given phase)
    function firstPhaseAlignedOnOrAfterStart(layerId){
      const meta  = getMeta(layerId);
      const start = new Date(meta.start);
      const step  = meta.stepDays || 1;
      const phase = meta.phase ? new Date(meta.phase) : start;
      const k = Math.ceil((start - phase) / DAY / step);
      return addDays(phase, k*step);
    }

    // Snap to layer cadence; for NDVI use the phase grid; for daily, clamp to product start.
    function snapDateForLayer(d, layerId){
      const meta  = getMeta(layerId);
      const step  = meta.stepDays || 1;
      const prodStart = getProductStart(layerId);

      // Daily layers: just not before product start
      if (!meta.phase){
        const x = new Date(d);
        return (x < prodStart) ? prodStart : new Date(x.getFullYear(), x.getMonth(), x.getDate());
      }

      // NDVI with phase
      const phase = new Date(meta.phase);
      const alignedStart = firstPhaseAlignedOnOrAfterStart(layerId);
      const diffSteps = Math.floor((d - phase) / DAY / step);
      let snapped = addDays(phase, diffSteps*step);
      if (snapped < alignedStart) snapped = alignedStart;
      return snapped;
    }

    // ---------- Tiles ----------
    function createGIBSLayer(layerId, dateISO){
      const meta = getMeta(layerId);
      const url  = `https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/${layerId}/default/${dateISO}/GoogleMapsCompatible_Level9/{z}/{y}/{x}.${meta.ext}`;
      return L.tileLayer(url, {
        attribution: '© NASA EOSDIS GIBS',
        tileSize: 256,
        noWrap: true,
        crossOrigin: true,
        bounds: [[-85.0511,-180],[85.0511,180]]
      });
    }

    // ---------- Slider range/labels ----------
    function setSliderRange(){
      const end = today();
      const max = Math.max(0, daysBetween(GLOBAL_BASE_START, end));
      timeSlider.min = "0";
      timeSlider.max = String(max);

      const startYear = GLOBAL_BASE_START.getFullYear();
      const endYear   = end.getFullYear();
      labelStart.textContent = startYear;
      labelMid.textContent   = Math.floor((startYear + endYear)/2);
      labelEnd.textContent   = endYear;
    }

    function snapSliderTo(date){
      const idx = daysBetween(GLOBAL_BASE_START, date);
      timeSlider.value = String(idx);
    }

    // ---------- Map update (await tiles) ----------
    async function updateMap(){
      const layerId = layerSelect.value;
      const raw     = dateFromSlider(timeSlider.value);
      const snapped = snapDateForLayer(raw, layerId);
      const dateStr = toISODate(snapped);
      dateDisplay.textContent = dateStr;

      if (currentLayer){ currentLayer.off(); map.removeLayer(currentLayer); }
      //loading.classList.add('active');

      const layer = createGIBSLayer(layerId, dateStr);
      currentLayer = layer;

      await new Promise((resolve)=>{
        const done = ()=> resolve();
        layer.once('load', done);
        layer.once('tileerror', done);
        setTimeout(done, 0); // time to load
      });

      layer.addTo(map);
      //loading.classList.remove('active');
    }

    // ---------- Play backwards starting FROM 2025-11-05 for NDVI ----------
    async function togglePlay(){
      if (playing){ playing = false; playBtn.textContent = '▶ Play'; return; }
      playing = true; playBtn.textContent = '⏸ Pause';

      const layerId = layerSelect.value;
      const meta    = getMeta(layerId);
      const step    = meta.stepDays || 1;

      // If NDVI, force starting point = 2025-11-05 (your request).
      if (layerId === "MODIS_Terra_NDVI_8Day"){
        const anchor = new Date("2025-11-05");     // start FROM here
        const startFrom = snapDateForLayer(anchor, layerId); // ensure it's on the 8-day grid
        snapSliderTo(startFrom);
        await updateMap();
      }

      while (playing){
        // move backwards by layer cadence
        let nextIdx = parseInt(timeSlider.value,10) - step;

        if (layerId === "MODIS_Terra_NDVI_8Day"){
          // If we go before the earliest phase-aligned NDVI date, wrap back to anchor 2025-11-05
          const earliest = firstPhaseAlignedOnOrAfterStart(layerId);
          const earliestIdx = daysBetween(GLOBAL_BASE_START, earliest);
          if (nextIdx < earliestIdx){
            const anchor = snapDateForLayer(new Date("2025-11-05"), layerId);
            nextIdx = daysBetween(GLOBAL_BASE_START, anchor);
          }
        } else {
          // daily layers wrap to "today"
          if (nextIdx < 0) nextIdx = parseInt(timeSlider.max,10);
        }

        timeSlider.value = String(nextIdx);
        await updateMap();
        await new Promise(r=>setTimeout(r, 3000)); // pacing
      }
    }

    function goToToday(){
      const t = snapDateForLayer(today(), layerSelect.value);
      snapSliderTo(t);
      updateMap();
    }

    // ---------- Events ----------
    timeSlider.addEventListener('input', ()=> updateMap());
    layerSelect.addEventListener('change', ()=>{
      // keep current date but snap for the new layer
      const raw = dateFromSlider(timeSlider.value);
      const snapped = snapDateForLayer(raw, layerSelect.value);
      snapSliderTo(snapped);
      updateMap();
    });
    playBtn.addEventListener('click', togglePlay);
    todayBtn.addEventListener('click', goToToday);

    // ---------- Init ----------
    setSliderRange();
    // Start at today's valid date for default layer
    const startAt = snapDateForLayer(today(), layerSelect.value);
    snapSliderTo(startAt);
    updateMap();
  </script>
</body>
</html>
